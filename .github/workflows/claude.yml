name: Claude Code

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: >-
      (github.event_name == 'issues' && github.event.label.name == 'claude' && 
       contains(fromJson('["mlr"]'), github.event.sender.login)) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && 
       contains(fromJson('["OWNER", "MEMBER"]'), github.event.comment.author_association)) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && 
       contains(fromJson('["OWNER", "MEMBER"]'), github.event.review.author_association)) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && 
       contains(fromJson('["OWNER", "MEMBER"]'), github.event.comment.author_association))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Custom prompt with strict formatting rules
          prompt: |
            **IMPORTANT - WHEN WORKING ON ISSUES:**
            After you finish implementing the code changes and committing them, create a pull request:
            ```
            gh pr create --title "Your descriptive title" --body "## Summary
            Your summary of what was implemented.
             
            Closes #${{ github.event.issue.number }}"
            ```
            Always include a summary of changes AND "Closes #${{ github.event.issue.number }}" in the body.
             
            **COMMIT RULES:**
            - Do NOT add "Co-authored-by" lines to commits
            - Do NOT add "Generated with Claude Code" or similar attributions
            - Keep commits clean and professional
          
            **WHEN WORKING ON PR FEEDBACK:**
            Make the requested changes and commit. The PR will automatically update - do NOT create a new PR.
           
            **WHEN FIXING CI FAILURES:**
            Fix the issues, commit the fix. The CI will automatically re-run.
           
            **OUTPUT RULES:**
          
            ## Commit Message Requirements (max 72 chars)
            - Imperative mood: "Add" not "Added"
            - Action verbs: Add, Update, Fix, Remove, Refactor, Implement
            - No articles (a, an, the)
            - No punctuation at end
            - No prefixes like "feat:", "fix:"
            - Single line only
            - NO co-author attributions

          # Enable progress tracking
          track_progress: true

          # Claude CLI arguments
          claude_args: |
            --model "claude-opus-4-6"
            --max-turns 100
            --allowedTools "Bash(git:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh repo:*),Bash(npm:*),Bash(npx:*),Edit,Write,Read,Glob,Grep,LS,WebSearch,WebFetch"

      # Clean up the comment - remove the malformed "Create PR" link and trailing artifacts
      - name: Clean up Claude comment
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Get the latest comment from Claude on this issue
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments --jq '.[-1].id')

          if [ -n "$COMMENT_ID" ]; then
            # Get current comment body
            BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID --jq '.body')

            # Remove the "Create PR" link and any trailing pipe/whitespace
            CLEANED=$(echo "$BODY" | sed 's/ • \[Create PR ➔\]([^)]*)//g' | sed 's/[[:space:]]*|[[:space:]]*$//')

            # Update the comment
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH \
              -f body="$CLEANED"
          fi
